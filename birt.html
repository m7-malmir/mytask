var $form;
var PaymentMethod;
var total_count = 0;
var total_sum = 0;
var current_role_id = 0;
$(function(){
	$form = (function()
	{
		var pk,
			inEditMode = false,
			primaryKeyName = "Id",
			bindingSourceName = "BS_PaymentProcess",
            insertFromData = FormManager.insertEntity;
		
		function init()
		{
			if(typeof dialogArguments !== "undefined")
			{
				if(primaryKeyName in dialogArguments)
				{
					pk = dialogArguments[primaryKeyName];
					inEditMode = true;
					readData();
				}
				if("FormParams" in dialogArguments)
				{
					pk = dialogArguments.FormParams;
					inEditMode = true;
					readData();
				}
			}
			build();
			createControls();
			bindEvents();
		}
		
		function build()
		{
			$("body").css({overflow: "hidden"}).attr({scroll: "no"});
			$("#Form1").css({top: "0", left: "0", width: $(document).width() + "px", height: $(document).height() + "px"});
		}

		function createControls()
		{
			if(!inEditMode){
				$("#ButtonControl13").show();
			}
			alert(JSON.stringify('aaaa'));
			if(/*check_date*/1){
				UserService.GetCurrentActor(true,
					function(data){
						hideLoading();
						var xmlActor = $.xmlDOM(data);
						currentActorId = xmlActor.find('actor').attr('pk');
						var params = {'actor_id': currentActorId}
						FormManager.GetRoleId(params,
							function(list)
							{
								current_role_id = list[0]["RoleId"];
								if(current_role_id == 30){
									$("#ButtonControl14").show();
									$("#ButtonControl11").hide();
									$("#ButtonControl12").hide();
								}else{
									if(inEditMode){
										$("#ButtonControl13").show();
										$("#LabelControl1").show();
										$("#DatePickerControl1").show();
										$("#LabelControl2").show();
										$("#TextBoxControl2").show();
										$("#LabelControl3").show();
										$("#TextBoxControl3").show();
										$("#LabelControl4").show();
										$("#TextBoxControl4").show();
									}
								}
							},
							function(err)
							{
								hideLoading();
								alert(err);
							}
						);
						tblMeetingPersons.refresh();
							
					},
					function(err){
						hideLoading();
						$ErrorHandling.Erro(err,"خطا در سرویس getCurrentActor");
					}
				);
			}else{
				$.alert("بازه مجاز پرداخت از چهاردهم هر ماه بجز فروردین و اسفند است.","","rtl",function(){
					hideLoading();
		        	closeWindow({OK:true, Result:null});
				});
			}
		}

		function bindEvents()
		{
			/*randomFileId = Math.floor(Math.random() * (1000000000)) - 2000000;
			firstRandomId = randomFileId;*/
		}

		function readData()
		{
			
			/*showLoading();
			readFromData({Where: primaryKeyName + " = " + pk},
				function(dataXml)
				{
					hideLoading();
					$.setFormDataValues(bindingSourceName, dataXml);
				},
				function(err)
				{
					hideLoading();
					alert(err);
				}
			);*/
		}

		function getPK()
		{
			return pk;
		}

		function isInEditMode()
		{
			return inEditMode;
		}

		function saveData(callback)
		{
			validateForm(
				function()
				{
					if(inEditMode)
					{
						//updateData(callback);
					}
					else
					{
						insertData(callback);
					}
				},
				function()
				{
					$.alert("لطفا موارد اجباری را تکمیل نمایید.", "", "rtl",
						function()
						{}
					);
				}
			);
		}

		function insertData(callback)
		{
			//showLoading();
			var params = $.getFormDataValues(bindingSourceName);
			params.CreatorActor_ID = currentActorId;
			params.PaymentAmount = rcommafy($("#txtAllAmount").val());
			params.PaymentReqAmount = $("#txtAllReqs").val();
			insertFromData(params,
				function(dataXml)
				{
					pk = dataXml.find("row:first").find(">col[name='" + primaryKeyName + "']").text();
					randomFileId = pk;
					var result = "<data><" + primaryKeyName + ">" + pk + "</" + primaryKeyName + "></data>";
					inEditMode = true;
					WorkflowService.RunWorkflow("ZJM.FMS.FPP.FundPaymentProcess",
					    '<Content><Id>'+pk+'</Id></Content>',
					    true,
					    function(data)
					    {
					        $.alert("درخواست پرداخت با موفقیت ارسال شد.","","rtl",function(){
								hideLoading();
					        	closeWindow({OK:true, Result:null});
							});				
					    }
					    ,function(err)
					    {
					        alert('مشکلی در شروع فرآیند به وجود آمده. '+err);
					        hideLoading();
					    }
					);	
					hideLoading();
					if($.isFunction(callback))
					{
						callback();
					}
				},
				function(err)
				{
					hideLoading();
					alert(err);
				}
			);
		}

		function updateData(callback)
		{
			//showLoading();
		}
		
		function deleteData(callback)
		{
			showLoading();
		}

		function validateForm(onSuccess, onError)
		{
			try
			{
				$("[role]").validateData(true);
				if($.isFunction(onSuccess))
				{
					onSuccess();
				}
			}
			catch(e)
			{
				if($.isFunction(onError))
				{
					onError();
				}
			}
		}
		
		return {
			init: init,
			getPK: getPK,
			isInEditMode: isInEditMode,
			saveData: saveData
		};
	}());
	$form.init();
});